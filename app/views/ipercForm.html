<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>IPERC Matriz Oficial - Per√∫</title>
  <style>
      /* Sidebar desplegable */
      .layout { display: grid; grid-template-columns: 260px 1fr; gap: 16px; }
      .sidebar { background: #ffffff; border: 1px solid #e3e6ea; border-radius: 8px; padding: 10px; height: fit-content; }
      .sidebar h3 { font-size: 1rem; margin-bottom: 8px; color: #1a5276; display:flex; justify-content:space-between; align-items:center; }
      .sidebar .toggle { cursor:pointer; font-size:0.9rem; color:#2980b9; }
      .sidebar.collapsed { width: 40px; padding: 6px; }
      .sidebar.collapsed .content { display:none; }
      .sidebar ul { list-style: none; max-height: 400px; overflow:auto; padding:0; }
      .sidebar li { padding: 6px 8px; border-bottom: 1px solid #f0f3f5; display:flex; justify-content:space-between; align-items:center; }
      .sidebar li a { color: #2980b9; text-decoration: none; }
      .sidebar .meta { font-size: 0.8rem; color:#7f8c8d; }
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f5f7fa;
      color: #333;
      line-height: 1.6;
      padding: 10px;
    }
    .container {
      max-width: 100%;
      margin: 0 auto;
      background: white;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      overflow: hidden;
    }

    .header {
      background: #1a5276;
      color: white;
      padding: 20px;
      text-align: center;
    }
    .header h1 {
      font-size: 1.6rem;
      margin-bottom: 5px;
    }
    .header p {
      font-size: 0.95rem;
      opacity: 0.9;
    }

    .section {
      padding: 20px;
    }
    .section-title {
      font-size: 1.2rem;
      color: #1a5276;
      margin-bottom: 15px;
      padding-bottom: 8px;
      border-bottom: 2px solid #3498db;
    }

    .form-grid {
      display: grid;
      gap: 15px;
      margin-bottom: 20px;
    }
    @media (min-width: 768px) {
      .form-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
      color: #2c3e50;
      font-size: 0.95rem;
    }
    .form-control {
      width: 100%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 1rem;
    }
    textarea.form-control {
      resize: vertical;
      min-height: 80px;
      font-family: inherit;
      line-height: 1.4;
    }
    input.form-control {
      height: 40px;
    }
    .form-control:focus {
      outline: none;
      border-color: #3498db;
      box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
    }

    /* Tabla responsiva */
    .risk-table-container {
      overflow-x: auto;
      margin-top: 20px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
      font-size: 0.9rem;
    }
    th, td {
      border: 1px solid #bdc3c7;
      padding: 8px;
      text-align: left;
    }
    th {
      background: #ecf0f1;
      font-weight: bold;
      font-size: 0.95rem;
    }
    tr:nth-child(even) {
      background: #fafafa;
    }

    /* Columnas espec√≠ficas */
    .col-n { width: 40px; text-align: center; }
    .col-actividad { min-width: 150px; }
    .col-peligro { min-width: 150px; }
    .col-consecuencia { min-width: 200px; }
    .col-medidas-exist { min-width: 150px; }
    .col-prob { width: 60px; text-align: center; }
    .col-sev { width: 60px; text-align: center; }
    .col-mr { width: 60px; text-align: center; font-weight: bold; }
    .col-medidas-impl { min-width: 150px; }
    .col-responsable { width: 120px; }

    /* Estilos para Mr (color seg√∫n valor) */
    .mr-rojo { background: #ff6b6b; color: white; }
    .mr-naranja { background: #ffa500; color: white; }
    .mr-amarillo { background: #ffd700; color: black; }
    .mr-verde { background: #4cd137; color: white; }

    .btn {
      padding: 10px 18px;
      border: none;
      border-radius: 6px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: opacity 0.2s;
    }
    .btn-add {
      background: #27ae60;
      color: white;
      display: block;
      margin: 15px auto;
      width: fit-content;
    }
    .btn-submit {
      background: #2980b9;
      color: white;
      display: block;
      margin: 30px auto;
      padding: 12px 30px;
      font-size: 1.1rem;
      width: fit-content;
    }

    .footer {
      text-align: center;
      padding: 15px;
      color: #7f8c8d;
      font-size: 0.9rem;
      border-top: 1px solid #eee;
    }

    /* Tabla de gu√≠a */
    /* Gu√≠a compacta */
    .guide-table {
      margin: 12px 0;
      border: 1px solid #ddd;
      border-radius: 6px;
      overflow: hidden;
      max-width: 800px;
      margin-left: auto;
      margin-right: auto;
    }
    .guide-table h3 {
      background: #3498db;
      color: white;
      padding: 8px;
      text-align: center;
      margin: 0;
      font-size: 0.95rem;
    }
    .guide-table table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
    }
    .guide-table th, .guide-table td {
      border: 1px solid #ddd;
      padding: 6px;
      text-align: center;
    }
    .guide-table th {
      background: #ecf0f1;
      font-weight: 600;
    }
    .guide-table .rojo { background: #ff6b6b; color: white; }
    .guide-table .naranja { background: #ffa500; color: white; }
    .guide-table .amarillo { background: #ffd700; color: black; }
    .guide-table .verde { background: #4cd137; color: white; }
  </style>
</head>
<body>
  <div class="container">
    <div class="layout">
      <aside class="sidebar" id="sidebar">
        <h3>
          IPERC Generados
          <span>
            <button type="button" class="btn" style="background:#eef6ff;color:#2980b9;padding:6px 10px" onclick="loadIpercList()">‚Üª Actualizar</button>
            <button type="button" class="btn" style="background:#f4f6f8;color:#1a5276;padding:6px 10px" onclick="toggleSidebar()" id="toggleBtn">Ocultar</button>
          </span>
        </h3>
        <div class="content">
          <ul id="ipercList"><li style="padding:6px 8px;color:#7f8c8d">No hay IPERC guardados a√∫n.</li></ul>
        </div>
      </aside>
      <main>
    <div class="header">
      <h1>‚úÖ MATRIZ DE IDENTIFICACI√ìN DE PELIGROS Y EVALUACI√ìN DE RIESGOS (IPERC)</h1>
      <p>Seg√∫n Normativa Peruana - MTPE</p>
    </div>

    <form id="ipercForm" method="POST" action="/iperc">
      
      <!-- Encabezado -->
      <div class="section">
        <h2 class="section-title">üìã Informaci√≥n General</h2>
        <div class="form-grid">
          <div class="form-group">
            <label for="company">Raz√≥n Social o Denominaci√≥n Social</label>
            <input type="text" id="company" name="company" class="form-control" required>
          </div>
          <div class="form-group">
            <label for="area">√Årea</label>
            <input type="text" id="area" name="area" class="form-control" required>
          </div>
          <div class="form-group">
            <label for="process">Proceso</label>
            <input type="text" id="process" name="process" class="form-control" required>
          </div>
        </div>
      </div>

      <!-- Matriz de riesgos -->
      <div class="section">
        <h2 class="section-title">üìä Matriz de Evaluaci√≥n de Riesgos</h2>
        <div class="risk-table-container">
          <table id="ipercTable">
            <thead>
              <tr>
                <th class="col-n">N¬∞</th>
                <th class="col-actividad">ACTIVIDAD</th>
                <th class="col-peligro">PELIGRO</th>
                <th class="col-consecuencia">CONSECUENCIA RIESGO</th>
                <th class="col-medidas-exist">MEDIDAS DE CONTROL EXISTENTES</th>
                <th class="col-prob">PROBABILIDAD (P)</th>
                <th class="col-sev">SEVERIDAD (S)</th>
                <th class="col-mr">Mr = P√óS</th>
                <th class="col-medidas-impl">MEDIDAS DE CONTROL A IMPLEMENTAR</th>
                <th class="col-responsable">RESPONSABLE</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td class="col-n">1</td>
                <td class="col-actividad"><input name="rows[0].activity" class="form-control" required></td>
                <td class="col-peligro"><input name="rows[0].hazard" class="form-control" required></td>
                <td class="col-consecuencia"><textarea name="rows[0].consequence" class="form-control" rows="2" required></textarea></td>
                <td class="col-medidas-exist"><textarea name="rows[0].existingControls" class="form-control" rows="2"></textarea></td>
                <td class="col-prob"><input type="number" min="1" max="5" name="rows[0].probability" class="form-control" required></td>
                <td class="col-sev"><input type="number" min="1" max="50" name="rows[0].severity" class="form-control" required></td>
                <td class="col-mr"><span id="mr-0">‚Äî</span></td>
                <td class="col-medidas-impl"><textarea name="rows[0].newControls" class="form-control" rows="2"></textarea></td>
                <td class="col-responsable"><input name="rows[0].responsible" class="form-control" required></td>
                <td><button type="button" onclick="removeRow(this)">üóëÔ∏è</button></td>
              </tr>
            </tbody>
          </table>
        </div>
        <button type="button" class="btn btn-add" onclick="addRow()">+ A√±adir fila</button>
      </div>

      <!-- Gu√≠a de valoraci√≥n -->
      <div class="section">
        <h2 class="section-title">üìò Gu√≠a de Valoraci√≥n de Riesgos</h2>
        <div class="guide-table">
          <h3>Severidad vs Probabilidad (Gu√≠a)</h3>
          <table>
            <thead>
              <tr>
                <th rowspan="2">SEVERIDAD</th>
                <th colspan="5">PROBABILIDAD</th>
              </tr>
              <tr>
                <th>Escasa (1)</th>
                <th>Baja probabilidad (2)</th>
                <th>Puede suceder (3)</th>
                <th>Probable (4)</th>
                <th>Muy probable (5)</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>Catastr√≥ficos (50)</td>
                <td class="rojo">50</td>
                <td class="rojo">100</td>
                <td class="rojo">150</td>
                <td class="rojo">200</td>
                <td class="rojo">250</td>
              </tr>
              <tr>
                <td>Mayor (20)</td>
                <td class="naranja">20</td>
                <td class="naranja">40</td>
                <td class="naranja">60</td>
                <td class="naranja">80</td>
                <td class="naranja">100</td>
              </tr>
              <tr>
                <td>Moderado alto (10)</td>
                <td class="amarillo">10</td>
                <td class="amarillo">20</td>
                <td class="amarillo">30</td>
                <td class="amarillo">40</td>
                <td class="amarillo">50</td>
              </tr>
              <tr>
                <td>Moderado (5)</td>
                <td class="amarillo">5</td>
                <td class="amarillo">10</td>
                <td class="amarillo">15</td>
                <td class="amarillo">20</td>
                <td class="amarillo">25</td>
              </tr>
              <tr>
                <td>Moderado Leve (2)</td>
                <td class="verde">2</td>
                <td class="verde">4</td>
                <td class="verde">6</td>
                <td class="verde">8</td>
                <td class="verde">10</td>
              </tr>
              <tr>
                <td>M√≠nima (1)</td>
                <td class="verde">1</td>
                <td class="verde">2</td>
                <td class="verde">3</td>
                <td class="verde">4</td>
                <td class="verde">5</td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="guide-table">
          <h3>Valoraci√≥n de Riesgos (Gu√≠a)</h3>
          <table>
            <thead>
              <tr>
                <th>RIESGO</th>
                <th>COLOR</th>
                <th>RANGO</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>RIESGO CR√çTICO</td>
                <td class="rojo">ROJO</td>
                <td>50 < X ‚â§ 250</td>
              </tr>
              <tr>
                <td>RIESGO ALTO</td>
                <td class="naranja">NARANJA</td>
                <td>10 < X ‚â§ 50</td>
              </tr>
              <tr>
                <td>RIESGO MEDIO</td>
                <td class="amarillo">AMARILLO</td>
                <td>3 < X ‚â§ 10</td>
              </tr>
              <tr>
                <td>RIESGO BAJO</td>
                <td class="verde">VERDE</td>
                <td>X ‚â§ 3</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <div style="display: flex; gap: 15px; justify-content: center; margin: 30px 0;">
        <button type="button" class="btn btn-submit" onclick="submitForm('save')" style="background: #27ae60;">üíæ Guardar</button>
        <button type="button" class="btn btn-submit" onclick="submitForm('export')" style="background: #e67e22;">üì§ Exportar PDF</button>
        <button type="button" class="btn btn-submit" onclick="showList()" style="background: #2980b9;">üìö Ver lista</button>
      </div>
    </form>

    <div class="footer">
      <p>IPERC para Pymes - Proyecto Final Cloud Computing & DevOps</p>
    </div>
      </main>
    </div>
  </div>

  <script>
    let rowIndex = 1;

    async function loadIpercList() {
      try {
        const res = await fetch('/api/iperc');
        const data = await res.json();
        const ul = document.getElementById('ipercList');
        ul.innerHTML = data.map(d => `
          <li>
            <span>
              <a href="/iperc/${d.ipercId}/view" target="_blank">${d.ipercId}</a>
              <div class="meta">${d.company || ''} ¬∑ ${d.area || ''} ¬∑ ${d.process || ''}</div>
            </span>
            <a href="/iperc/${d.ipercId}">Editar</a>
          </li>
        `).join('');
      } catch (e) {
        console.error('Error cargando lista IPERC', e);
      }
    }

    function toggleSidebar() {
      const sb = document.getElementById('sidebar');
      sb.classList.toggle('collapsed');
      const tb = document.getElementById('toggleBtn');
      if (tb) tb.textContent = sb.classList.contains('collapsed') ? 'Mostrar' : 'Ocultar';
    }

    document.addEventListener('DOMContentLoaded', loadIpercList);
    function showList(){
      const sb = document.getElementById('sidebar');
      if (sb.classList.contains('collapsed')) sb.classList.remove('collapsed');
      loadIpercList();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    async function submitForm(action) {
      const form = document.getElementById('ipercForm');
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }

      // Enviar como application/x-www-form-urlencoded para que Express lo parsee
      const formData = new FormData(form);
      const params = new URLSearchParams();
      for (const [key, value] of formData.entries()) {
        params.append(key, value);
      }
      try {
        const response = await fetch('/iperc', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: params.toString()
        });
        
        if (!response.ok) {
          const text = await response.text();
          alert('Error al guardar: ' + text);
          return;
        }

        const html = await response.text();
        const match = html.match(/IPERC-\d{4}-[A-Z0-9]+/);
        if (!match) {
          alert('IPERC guardado, pero no se pudo extraer el ID.');
          return;
        }

        const ipercId = match[0];
        
        if (action === 'save') {
          alert(`‚úÖ IPERC guardado con ID: ${ipercId}`);
          showList();
        } else if (action === 'export') {
          window.open(`/pdf/${ipercId}?download=1`, '_blank');
          setTimeout(() => showList(), 500);
        }
      } catch (err) {
        alert('Error de conexi√≥n: ' + err.message);
      }
    }

    function addRow() {
      const tbody = document.querySelector('#ipercTable tbody');
      const newRow = document.createElement('tr');
      newRow.innerHTML = `
        <td class="col-n">${rowIndex + 1}</td>
        <td class="col-actividad"><input name="rows[${rowIndex}].activity" class="form-control" required></td>
        <td class="col-peligro"><input name="rows[${rowIndex}].hazard" class="form-control" required></td>
        <td class="col-consecuencia"><textarea name="rows[${rowIndex}].consequence" class="form-control" rows="2" required></textarea></td>
        <td class="col-medidas-exist"><textarea name="rows[${rowIndex}].existingControls" class="form-control" rows="2"></textarea></td>
        <td class="col-prob"><input type="number" min="1" max="5" name="rows[${rowIndex}].probability" class="form-control" required></td>
        <td class="col-sev"><input type="number" min="1" max="50" name="rows[${rowIndex}].severity" class="form-control" required></td>
        <td class="col-mr"><span id="mr-${rowIndex}">‚Äî</span></td>
        <td class="col-medidas-impl"><textarea name="rows[${rowIndex}].newControls" class="form-control" rows="2"></textarea></td>
        <td class="col-responsable"><input name="rows[${rowIndex}].responsible" class="form-control"></td>
        <td><button type="button" onclick="removeRow(this)">üóëÔ∏è</button></td>
      `;
      tbody.appendChild(newRow);
      rowIndex++;
    }

    function removeRow(button) {
      const row = button.closest('tr');
      if (document.querySelectorAll('#ipercTable tbody tr').length > 1) {
        row.remove();
        // Actualizar n√∫meros
        document.querySelectorAll('#ipercTable tbody tr').forEach((tr, i) => {
          tr.cells[0].textContent = i + 1;
        });
      } else {
        alert('Debe haber al menos una fila en la matriz.');
      }
    }

    // Calcular Mr en tiempo real
    document.addEventListener('input', (e) => {
      if (e.target.name && e.target.name.startsWith('rows[')) {
        const name = e.target.name;
        const index = name.match(/\[(\d+)\]/)[1];
        const prob = parseInt(document.querySelector(`input[name="rows[${index}].probability"]`).value) || 0;
        const sev = parseInt(document.querySelector(`input[name="rows[${index}].severity"]`).value) || 0;
        const mr = prob * sev;
        const mrCell = document.getElementById(`mr-${index}`);
        mrCell.textContent = mr;

        // Aplicar color seg√∫n valor
        let className = '';
        if (mr <= 3) className = 'mr-verde';
        else if (mr <= 10) className = 'mr-amarillo';
        else if (mr <= 50) className = 'mr-naranja';
        else if (mr <= 250) className = 'mr-rojo';

        mrCell.className = `col-mr ${className}`;
      }
    });
  </script>
</body>
</html>